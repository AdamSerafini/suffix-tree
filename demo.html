<!doctype html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Language" content="en">
</head>
<html lang="en">
  <body>
    <h2>Ukkonen's Algorithm: A Visual Guide</h2>
    <input id="input" type="text" value="xabxa$" maxlength="10">
    <div id="svgDiv">
      <!-- Target for dynamic svg generation -->
    </div>
  </body>
  <script>
    // Display each phase of the Suffix Tree for the string in the input.

    // DOM nodes
    var svgDiv = document.getElementById('svgDiv');
    var input = document.getElementById('input');

    /*
    Initialise a Web Worker that returns the GraphViz SVG.
    The event handler replaces the placeholder with the string returned by
    the worker.
    */
    var worker = new Worker('worker.js');
    worker.onmessage = function(e) {
      var placeholder = document.getElementById(e.data['slice']);

      if (placeholder) {
        placeholder.outerHTML = e.data['tree'];
      }
    }

    /*
    Return the longest matching prefix of two strings where the 'longest
    matching prefix' of 'abc' and 'abd' is 'ab'.
    */
    var getPrefix = function(strA, strB) {
      var ret = '';
      var i = 0;
      var lA = strA.length, lB = strB.length;
      while (strA.charAt(i) == strB.charAt(i) && i < lA && i < lB) {
          ret += strA.charAt(i);
          i++;
      }
      return ret;
    }

    /*
    Keep track of the last string rendered so a 'diff' can be used to
    minimize unnecessary work.
    */
    var lastRendered = '';

    var render = function() {
      var str = input.value;

      // Find the shared prefix between the new string and the last
      var prefix = getPrefix(str, lastRendered);
      var prefixLen = prefix.length;

      // Get the existing svg nodes as an array
      var svgElements = Array.from(document.getElementsByTagName('svg'));

      // Remove superflous svg nodes
      svgElements.slice(prefixLen).forEach(function(el) {el.remove()});

      // Add new SVG nodes
      for (var i = prefixLen + 1; i <= str.length; ++i) {
        var slice = str.slice(0, i);
        /*
        Create a placeholder element that will be populated when the worker
        returns.
        */
        var placeholder = document.createElement('svg');
        placeholder.setAttribute("id", slice);
        svgDiv.appendChild(placeholder);

        // Ask the GraphViz worker to create the diagram.
        worker.postMessage(slice);
      }
      lastRendered = str;
    };

    // A super-simple debouncer
    var debounce = function(func, wait) {
      var timeout;
      var later = function() {
        func.call();
      };
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    };

    // Add events
    document.addEventListener("DOMContentLoaded", render);
    input.addEventListener("input", debounce(render, 250));

  </script>
</html>
